<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.45">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2024-07-31">

<title>On Postgres Concurrency – Mike's blog</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Mike’s blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">On Postgres Concurrency</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">programming</div>
                <div class="quarto-category">software architecture</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">July 31, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  <div>
    <div class="abstract">
      <div class="block-title">Abstract</div>
      <p>Several concurrency patters presented</p>
    </div>
  </div>
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#experimental-environment" id="toc-experimental-environment" class="nav-link active" data-scroll-target="#experimental-environment"><span class="header-section-number">1</span> Experimental environment</a></li>
  <li><a href="#bare-minimum---repeatable-reads-rc-level" id="toc-bare-minimum---repeatable-reads-rc-level" class="nav-link" data-scroll-target="#bare-minimum---repeatable-reads-rc-level"><span class="header-section-number">2</span> Bare minimum - Repeatable Reads (RC) level</a></li>
  <li><a href="#non-consistent-snapshot" id="toc-non-consistent-snapshot" class="nav-link" data-scroll-target="#non-consistent-snapshot"><span class="header-section-number">3</span> Non-consistent snapshot</a></li>
  <li><a href="#need-for-locks" id="toc-need-for-locks" class="nav-link" data-scroll-target="#need-for-locks"><span class="header-section-number">4</span> Need for locks</a></li>
  <li><a href="#golden-mean---repeatable-reads-rr-level" id="toc-golden-mean---repeatable-reads-rr-level" class="nav-link" data-scroll-target="#golden-mean---repeatable-reads-rr-level"><span class="header-section-number">5</span> Golden mean - Repeatable Reads (RR) level</a></li>
  <li><a href="#serializable-s---too-safe-to-be-true" id="toc-serializable-s---too-safe-to-be-true" class="nav-link" data-scroll-target="#serializable-s---too-safe-to-be-true"><span class="header-section-number">6</span> Serializable (S) - too safe to be true</a></li>
  <li><a href="#summary---mental-model" id="toc-summary---mental-model" class="nav-link" data-scroll-target="#summary---mental-model"><span class="header-section-number">7</span> Summary - mental model</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">





<div id="fig-counter-lost-update" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-counter-lost-update-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="pg_conc1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Figure&nbsp;1: Counter - lost update"><img src="pg_conc1.png" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-counter-lost-update-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Counter - lost update
</figcaption>
</figure>
</div>
<section id="experimental-environment" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Experimental environment</h1>
<p>To check behaviour of postgres, we will run the official docker container, and create some tables. We will use sqlalchemy ORM for working with that.</p>
<div id="cell-6" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># !docker run -d --name pg-concurrency -e POSTGRES_PASSWORD=mysecretpassword -p 2345:5432 postgres</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="tables-setup" class="cell" data-execution_count="23">
<details class="code-fold">
<summary>Tables used in examples</summary>
<div class="sourceCode cell-code" id="Z" data-lst-cap="Y"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="Z-1"><a href="#Z-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sqlalchemy <span class="im">import</span> create_engine, insert, select, text, Integer, String, Text</span>
<span id="Z-2"><a href="#Z-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sqlalchemy.orm <span class="im">import</span> declarative_base, mapped_column, Session</span>
<span id="Z-3"><a href="#Z-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pytest</span>
<span id="Z-4"><a href="#Z-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="Z-5"><a href="#Z-5" aria-hidden="true" tabindex="-1"></a>PG_URL <span class="op">=</span> <span class="st">'postgresql+psycopg2://postgres:mysecretpassword@localhost:2345/postgres'</span></span>
<span id="Z-6"><a href="#Z-6" aria-hidden="true" tabindex="-1"></a>engine <span class="op">=</span> create_engine(PG_URL)</span>
<span id="Z-7"><a href="#Z-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="Z-8"><a href="#Z-8" aria-hidden="true" tabindex="-1"></a>Base <span class="op">=</span> declarative_base()</span>
<span id="Z-9"><a href="#Z-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="Z-10"><a href="#Z-10" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> User(Base):</span>
<span id="Z-11"><a href="#Z-11" aria-hidden="true" tabindex="-1"></a>    __tablename__ <span class="op">=</span> <span class="st">'users'</span></span>
<span id="Z-12"><a href="#Z-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="Z-13"><a href="#Z-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">id</span> <span class="op">=</span> mapped_column(Integer, primary_key<span class="op">=</span><span class="va">True</span>)</span>
<span id="Z-14"><a href="#Z-14" aria-hidden="true" tabindex="-1"></a>    name <span class="op">=</span> mapped_column(String, nullable<span class="op">=</span><span class="va">True</span>)</span>
<span id="Z-15"><a href="#Z-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="Z-16"><a href="#Z-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="Z-17"><a href="#Z-17" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Product(Base):</span>
<span id="Z-18"><a href="#Z-18" aria-hidden="true" tabindex="-1"></a>    __tablename__ <span class="op">=</span> <span class="st">'product'</span></span>
<span id="Z-19"><a href="#Z-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="Z-20"><a href="#Z-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">id</span> <span class="op">=</span> mapped_column(Integer, primary_key<span class="op">=</span><span class="va">True</span>)</span>
<span id="Z-21"><a href="#Z-21" aria-hidden="true" tabindex="-1"></a>    name <span class="op">=</span> mapped_column(String, nullable<span class="op">=</span><span class="va">True</span>)</span>
<span id="Z-22"><a href="#Z-22" aria-hidden="true" tabindex="-1"></a>    num_likes <span class="op">=</span> mapped_column(Integer, default<span class="op">=</span><span class="dv">0</span>)</span>
<span id="Z-23"><a href="#Z-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="Z-24"><a href="#Z-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__str__</span>(<span class="va">self</span>):</span>
<span id="Z-25"><a href="#Z-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f'p#</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span><span class="bu">id</span><span class="sc">}</span><span class="ss">'</span></span>
<span id="Z-26"><a href="#Z-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="Z-27"><a href="#Z-27" aria-hidden="true" tabindex="-1"></a>Base.metadata.drop_all(engine)</span>
<span id="Z-28"><a href="#Z-28" aria-hidden="true" tabindex="-1"></a>Base.metadata.create_all(engine)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="utilities" class="cell" data-execution_count="24">
<details class="code-fold">
<summary>Utilities used in examples</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>ses_autocommit <span class="op">=</span> Session(</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    engine.execution_options(isolation_level<span class="op">=</span><span class="st">"AUTOCOMMIT"</span>), </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    autoflush<span class="op">=</span><span class="va">True</span>, autobegin<span class="op">=</span><span class="va">True</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean table</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> clean_table():</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    ses_autocommit.execute(text(<span class="st">"DELETE from product"</span>))<span class="co">#; session.commit()</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    ses_autocommit.execute(text(<span class="st">"DELETE from users"</span>))<span class="co">#; session.commit()</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sqlalchemy.orm <span class="im">import</span> sessionmaker</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>ReadCommittedSession <span class="op">=</span> sessionmaker(create_engine(PG_URL, isolation_level<span class="op">=</span><span class="st">'READ COMMITTED'</span>), autoflush<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>RepeatableReadSession <span class="op">=</span> sessionmaker(create_engine(PG_URL, isolation_level<span class="op">=</span><span class="st">"REPEATABLE READ"</span>), autoflush<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>SerializableSession <span class="op">=</span> sessionmaker(create_engine(PG_URL, isolation_level<span class="op">=</span><span class="st">"SERIALIZABLE"</span>), autoflush<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="bare-minimum---repeatable-reads-rc-level" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Bare minimum - Repeatable Reads (RC) level</h1>
<p>The minimal isolation level, which provides only basic guarantee - nobody sees changes produced by a transaction unless it’s committed. This is called, <strong>“dirty reads”</strong> prevented. Otherwise it would be a nightmare, isn’t it?</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Could we go below this level, and database would allow dirty reads? In SQl standard there’s a level called “READ UNCOMMITTED” which sits below RC and suppose to do exactly this, but Postgres developers decided to not implement it. More correctly, it presents but behaves exactly as RC. In the docs you can find the reasons for that: “This is because it is the only sensible way to map the standard isolation levels to PostgreSQL’s multiversion concurrency control architecture.”. But actually I’m thinking it’s just not very helful for anything. I can barely imaging a system which would tolerate repeatable reads (as well as <strong>“repeatable writes”</strong>). This is basically an auto-commit mode with possibility to revert all changes back. Could be useful for something?</p>
</div>
</div>
<p>So, when you’re running in RC, you can be sure that nobody will see your changes before (and if) you commit. But which changes you see? The answer is, on each operation you see:</p>
<ul>
<li>your current changes (made by previous operations)</li>
<li>the most fresh global state of db (of course, comitted)</li>
</ul>
<p>It means, if some transaction committed in between your subsequent queries, it will immediately affect you on the next query (or commit).</p>
<p>These two behaviour aspects are illustrated in the following code:</p>
<div id="rc" class="cell" data-execution_count="21">
<details class="code-fold">
<summary>RC guarantees in action</summary>
<div class="sourceCode cell-code" id="Z" data-lst-cap="Y"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="Z-1"><a href="#Z-1" aria-hidden="true" tabindex="-1"></a>clean_table()</span>
<span id="Z-2"><a href="#Z-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="Z-3"><a href="#Z-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> (</span>
<span id="Z-4"><a href="#Z-4" aria-hidden="true" tabindex="-1"></a>    ReadCommittedSession() <span class="im">as</span> Alice,</span>
<span id="Z-5"><a href="#Z-5" aria-hidden="true" tabindex="-1"></a>    ReadCommittedSession() <span class="im">as</span> Bob</span>
<span id="Z-6"><a href="#Z-6" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="Z-7"><a href="#Z-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1</span></span>
<span id="Z-8"><a href="#Z-8" aria-hidden="true" tabindex="-1"></a>    Alice.add(</span>
<span id="Z-9"><a href="#Z-9" aria-hidden="true" tabindex="-1"></a>        Product(name<span class="op">=</span><span class="st">'inserted by Alice'</span>)</span>
<span id="Z-10"><a href="#Z-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="Z-11"><a href="#Z-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="Z-12"><a href="#Z-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2</span></span>
<span id="Z-13"><a href="#Z-13" aria-hidden="true" tabindex="-1"></a>    found <span class="op">=</span> Bob.query(Product).<span class="bu">filter</span>(Product.name<span class="op">==</span><span class="st">'inserted by Alice'</span>).<span class="bu">all</span>()</span>
<span id="Z-14"><a href="#Z-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="kw">not</span> found, <span class="st">"Dirty read prevented !"</span></span>
<span id="Z-15"><a href="#Z-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="Z-16"><a href="#Z-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3</span></span>
<span id="Z-17"><a href="#Z-17" aria-hidden="true" tabindex="-1"></a>    Alice.commit()</span>
<span id="Z-18"><a href="#Z-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="Z-19"><a href="#Z-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4: the same query now gives another result - this is called "non-repeatable reads"</span></span>
<span id="Z-20"><a href="#Z-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># which is fine for RC level</span></span>
<span id="Z-21"><a href="#Z-21" aria-hidden="true" tabindex="-1"></a>    found <span class="op">=</span> Bob.query(Product).<span class="bu">filter</span>(Product.name<span class="op">==</span><span class="st">'inserted by Alice'</span>).<span class="bu">all</span>()</span>
<span id="Z-22"><a href="#Z-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> found, <span class="st">"This is non-repeatable read :("</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="non-consistent-snapshot" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Non-consistent snapshot</h1>
<p>You may think, RR provides fair conditions? The second rule sounds even attractive - you’re working always with an up-to-date data. If something changes in db, you immediately sees it. Your code should just tolerate the case of <strong>“non-repeatable read”</strong> (or <strong>“phantom read”</strong>, there’re small differencies between these two anomalies, but essentially it’s the same): you run some query in the beginning of transaction, later repeat exactly the same query, and the result could be different. Maybe you’re working with some record, and your next operation is an update of this record; but another transaction just deleted this record in meanwhile; your code should not be broken because of that suprise.</p>
<p>If it doesn’t confuse you - all seems good.</p>
<p><strong>When it’s a not acceptable ?</strong></p>
<p>When you’re running a kind of snapshot of database state, and you need a consistent view of database.</p>
<p>Example:</p>
<p>Imagine banking system with 2 tables - Cards and Accounts. You going to make a report of current state of these 2 tables. The following transaction running in RC will provide you an inconsistent report:</p>
<ol type="1">
<li>You dump (<code>SELECT * FROM Accounts</code>) all the accounts</li>
<li>Some transaction creates a new card #N and account attached to it.</li>
<li>You dump all cards</li>
</ol>
<p>Result: The resulting report have broken link: a card #N with non-existing account.</p>
</section>
<section id="need-for-locks" class="level1 page-columns page-full" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Need for locks</h1>
<p>But another thing missed in RC is any kind of automatic locking, which help you to tackle concurrent data modifications.</p>
<p>The first example is <strong>lost update</strong>, occuring with quite standard Read-Modify-Write pattern. Imaging Accounts table, and Alice wants to send 10$ to Carl. The same wants to do Bob, and Carl should expect increase of 20$ on their balance. Both Bob and Alice runs their transactions in RC mode:</p>
<ol type="1">
<li>Alice reads account of Carl and observes the current balance of 100$</li>
<li>Bob does the same: reads account of Carl and observes the current balance of 100$</li>
<li>Alice adds 10 to current balance of 100, and updates Carl record with value of 110$. Commits.</li>
<li>Bob does the same: adds 10 to current balance of 100, and updates Carl record with value of 110$. Commits</li>
</ol>
<p>The last update of Bob overrides that one of Alice, and the resulting balance of Carl is only 110$.</p>
<p>You can say it’s quite naive to make increments on client side, and that could be fixed with database increments (<code>...SET balance = balance + 10</code>). While it helps in this case, it’s not a remedy in general situation.</p>
<p>Here’s another example:</p>
<p>Now you’re going to make a transfer from account “Alice”, but the only thing you should check beforehand is that account has enough money. Your transaction runs in RC mode:</p>
<ol type="1">
<li>You read Alice balance - let it be 100. It’s more that required 80$, so proceeding.</li>
<li>Some other transaction decreases balance to 50$.</li>
<li>You’re decreasing the balance by 80$ (with help of <code>UPDATE balance=balance-80 WHERE ...</code>).</li>
<li>Commit.</li>
</ol>
<p>Nothing prevents you to commit, process inapropriate spending. In result, Alice balance is negative. You could fix this exact case by imposing constrains on column “balance”, but there’s no general treatment.</p>
<p>Allright, all such cases should be resolved with locks. Reminding, there’re two types of locks:</p>
<ul>
<li>pessimistic locking, with help of real, explicit locks (<code>SELECT FOR UPDATE</code>)<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></li>
<li>optimistic locking, enforced by higher isolation levels</li>
</ul>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;Such locks has performance advantages in case of frequent contention. But a lot of disadvages, such as: 1. you need to take care of them manually, which complicates development 2. possibility of deadlocks 3. poor performance in case of extensive usage with low chance of conflict</p></div></div><p>So, staying on RC level, you can fallback to explicit locks in Read-Modify-Write cycle, or move to higher isolation level to enjoy safety provided by optimistic locking.</p>
<p>The following example is also illustrated in <a href="#fig-counter-lost-update" class="quarto-xref">Figure&nbsp;1</a>.</p>
<div id="cell-19" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example of lost update</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>clean_table()</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>product <span class="op">=</span> Product(name<span class="op">=</span><span class="st">'common'</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>ses_autocommit.add(product)<span class="co">#; ses_autocommit.commit()</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>ses_autocommit.flush()</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>level <span class="op">=</span> <span class="st">'READ COMMITTED'</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co"># level = 'REPEATABLE READ'</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> (</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    Session(create_engine(PG_URL, isolation_level <span class="op">=</span> level)) <span class="im">as</span> session_A,</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    Session(create_engine(PG_URL, isolation_level <span class="op">=</span> level)) <span class="im">as</span> session_B</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 1</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>        pA <span class="op">=</span> session_A.get(Product, product.<span class="bu">id</span>)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> pA.num_likes <span class="op">==</span> <span class="dv">0</span> </span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 2</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>        pB <span class="op">=</span> session_B.get(Product, product.<span class="bu">id</span>)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> pB.num_likes <span class="op">==</span> <span class="dv">0</span>         </span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 3</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>        pA.num_likes <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>        session_A.commit()</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 4</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>        pB.num_likes <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>        session_B.commit()</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>ses_autocommit.refresh(product)</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="co"># 5</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> product.num_likes <span class="op">==</span> <span class="dv">1</span>, <span class="st">"Update is lost"</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="golden-mean---repeatable-reads-rr-level" class="level1 page-columns page-full" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Golden mean - Repeatable Reads (RR) level</h1>
<p>RR level adds the following policies on top of RC:</p>
<ul>
<li>you’re working with the same database state (snapshot) from the beginning of the transaction to the end (commit)</li>
<li>optimistic locking is set for the records you modify</li>
</ul>
<p>When transaction begins, current database snapshot<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> is taking and you stay within it up to the end, this is why this level also called <strong>Snapshot Isolation</strong>. As we already discussed, it’s a neccesary condition for snapshots/reports generation, including full database dumps and system snapshots allowing to later restore.</p>
<div class="no-row-height column-margin column-container"><div id="fn2"><p><sup>2</sup>&nbsp;Internally it’s achieved through MVCC mechanism. It’s quite similar to Git - transaction starts its own branch with later attempt to merge back into master.</p></div></div><div id="cell-22" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prevention of non-repeatable read example</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>clean_table()</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> (</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    Session(create_engine(PG_URL)) <span class="im">as</span> session_A,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    Session(create_engine(PG_URL, isolation_level <span class="op">=</span> <span class="st">"REPEATABLE READ"</span>)) <span class="im">as</span> session_B</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 1</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        session_A.add(Product(name<span class="op">=</span><span class="st">'from A'</span>))</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 2</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>        found <span class="op">=</span> session_B.query(Product).<span class="bu">filter</span>(Product.name<span class="op">==</span><span class="st">'from A'</span>).<span class="bu">all</span>()</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> <span class="kw">not</span> found, <span class="st">"Dirty read prevented :)"</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 3</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>        session_A.commit()</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 4</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        found <span class="op">=</span> session_B.query(Product).<span class="bu">filter</span>(Product.name<span class="op">==</span><span class="st">'from A'</span>).<span class="bu">all</span>()</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> <span class="kw">not</span> found, <span class="st">"Non-repeatable read prevented :)"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>But probably more important feature provided by RR - optimistic locking on the data you write.</p>
<p>This way you handle a lot of concurrency issues, exactly concurrent modifying of the same records.</p>
<div id="cell-24" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pytest</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>clean_table()</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>product <span class="op">=</span> Product(name<span class="op">=</span><span class="st">'common'</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>ses_autocommit.add(product)<span class="op">;</span> ses_autocommit.flush()</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> (</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    ReadCommittedSession() <span class="im">as</span> Alice,  <span class="co"># This transaction could be on any level</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    RepeatableReadSession() <span class="im">as</span> Bob</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 1</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>        pA <span class="op">=</span> Alice.get(Product, product.<span class="bu">id</span>)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> pA.num_likes <span class="op">==</span> <span class="dv">0</span> </span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 2</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>        pB <span class="op">=</span> Bob.get(Product, product.<span class="bu">id</span>)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> pB.num_likes <span class="op">==</span> <span class="dv">0</span>         </span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 3</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>        pA.num_likes <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>        Alice.commit()</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 4: on this step, transaction was failed to commit, and lost update was prevented</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>        Bob.refresh(pB)</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> pB.num_likes <span class="op">==</span> <span class="dv">0</span>, <span class="st">"Repeatable read enforced"</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>        pB.num_likes <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> pytest.raises(<span class="pp">Exception</span>) <span class="im">as</span> excinfo:</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>            Bob.commit()</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> (</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>              <span class="st">"could not serialize access due to concurrent update"</span> <span class="kw">in</span> <span class="bu">str</span>(excinfo.value)</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>ses_autocommit.refresh(product)</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a><span class="co"># 5</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> product.num_likes <span class="op">==</span> <span class="dv">1</span>, <span class="st">"Second update was reverted"</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>How granular is the optimistic locking provided by RR? It has the same granularity as pessimistic ones (<code>SELECT FOR UPDATE Products WHERE id=1</code>). It means, you lock the whole row. Despite the other transactions could only modify another column of the row, you will not be able to commit. Technically, there will be no write conflicts or lost updates. Here’s an example:</p>
<div id="cell-26" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>clean_table()</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>product <span class="op">=</span> Product(name<span class="op">=</span><span class="st">'common'</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>ses_autocommit.add(product)<span class="op">;</span> ses_autocommit.flush()</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> (</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    ReadCommittedSession() <span class="im">as</span> Alice,  <span class="co"># This transaction could be on any level</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    RepeatableReadSession() <span class="im">as</span> Bob</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 1</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        pA <span class="op">=</span> Alice.get(Product, product.<span class="bu">id</span>)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> pA.num_likes <span class="op">==</span> <span class="dv">0</span> </span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 2</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>        pB <span class="op">=</span> Bob.get(Product, product.<span class="bu">id</span>)</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> pB.num_likes <span class="op">==</span> <span class="dv">0</span>         </span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 3 Alice modifies another column - name</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>        pA.name <span class="op">=</span> <span class="st">"Alice's favourite product"</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>        Alice.commit()</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 4: on this step, transaction was failed to commit, and lost update was prevented</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>        pB.num_likes <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> pytest.raises(<span class="pp">Exception</span>) <span class="im">as</span> excinfo:</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>            Bob.commit()</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> (</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>              <span class="st">"could not serialize access due to concurrent update"</span> <span class="kw">in</span> <span class="bu">str</span>(excinfo.value)</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>ses_autocommit.refresh(product)</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a><span class="co"># 5</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> product.name <span class="op">==</span> <span class="st">"Alice's favourite product"</span>, <span class="st">"Effect of Alice's transaction"</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> product.num_likes <span class="op">==</span> <span class="dv">0</span>, <span class="st">"Bob's transaction was not commited"</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As we see, RR is a powerful concurrency mechanism, capable to solve the cases of modifying the same records (rows). But what if there’re no row to impose lock onto? Basically, we’re talking about the case covered by whole-table locks: we want to enforce some business rule on table level, e.g.&nbsp;uniqueness of some type of records.</p>
<div id="cell-28" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>clean_table()</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>level <span class="op">=</span> <span class="st">'REPEATABLE READ'</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>unique_name <span class="op">=</span> <span class="st">'Unique'</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> (</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    Session(create_engine(PG_URL, isolation_level <span class="op">=</span> level)) <span class="im">as</span> session_A,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    Session(create_engine(PG_URL, isolation_level <span class="op">=</span> level)) <span class="im">as</span> session_B</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">#1</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    found <span class="op">=</span> session_A.query(Product).<span class="bu">filter</span>(Product.name <span class="op">==</span> unique_name).<span class="bu">all</span>()</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="kw">not</span> found, <span class="st">"A decides the name is not taken"</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    session_A.add(Product(name<span class="op">=</span>unique_name))</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">#2</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    found <span class="op">=</span> session_B.query(Product).<span class="bu">filter</span>(Product.name <span class="op">==</span> unique_name).<span class="bu">all</span>()</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="kw">not</span> found, <span class="st">"B decides the name is not taken"</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    session_B.add(Product(name<span class="op">=</span>unique_name))</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">#3</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    session_A.commit()</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    session_B.commit()</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>found <span class="op">=</span> session_A.query(Product).<span class="bu">filter</span>(Product.name <span class="op">==</span> unique_name).<span class="bu">all</span>()</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">len</span>(found) <span class="op">==</span> <span class="dv">2</span>, <span class="st">"Uniqness checking logic was bypassed :("</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In such cases, you can fallback to use of table-wide explicit locks.</p>
</section>
<section id="serializable-s---too-safe-to-be-true" class="level1 page-columns page-full" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Serializable (S) - too safe to be true</h1>
<p>Standard formulation: level S guarantees that if transaction commit is accepted, <strong>there’s an order of transactions which gives the same result</strong> if they are running one by one, serially. Which basically means - you can think there’s no concurrency at all, no concurrency anomalies could happen<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>.</p>
<div class="no-row-height column-margin column-container"><div id="fn3"><p><sup>3</sup>&nbsp;Of course - for those transactions which were commited. Basically, the only concurrency anomaly you can face - commit rejected.</p></div><div id="fn4"><p><sup>4</sup>&nbsp;Which is called <strong>predicate locks</strong></p></div></div><p>But I like to think about this level as an addon to RR, which adds <strong>an additional optimistic locks on read queries</strong><a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>. In addition to checking for the records you modify (which is available on RR too), you check for all the records you have read or could have read, in case they were already commited.</p>
<p>If you read some set of records in the beginning of transaction, and before your commit some other transaction did something which changes the result of the same query if it would be repeated now - your transaction will be rejected. It makes a lot of sense - you logic could depend on previous read results, and your actions would be different now, when data was changed.</p>
<p>Let’s look how it solves previous example of checking for table-wide uniqueness:</p>
<div id="cell-31" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>clean_table()</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>unique_name <span class="op">=</span> <span class="st">'Unique'</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Both transactions should be serial. !!</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> (</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    SerializableSession() <span class="im">as</span> Alice,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    SerializableSession() <span class="im">as</span> Bob</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">#1 Alice checks the name is not taken, and takes it</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    found <span class="op">=</span> Alice.query(Product).<span class="bu">filter</span>(Product.name <span class="op">==</span> unique_name).<span class="bu">all</span>()</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="kw">not</span> found, <span class="st">"Alice decides the name is not taken"</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    Alice.add(Product(name<span class="op">=</span>unique_name))</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">#2 Bob does the same</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    found <span class="op">=</span> Bob.query(Product).<span class="bu">filter</span>(Product.name <span class="op">==</span> unique_name).<span class="bu">all</span>()</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="kw">not</span> found, <span class="st">"Bob decides the name is not taken"</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    Bob.add(Product(name<span class="op">=</span>unique_name))</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">#3</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    Alice.commit()</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">#4</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> pytest.raises(<span class="pp">Exception</span>) <span class="im">as</span> excinfo:</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>        Bob.commit()</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> (</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">"could not serialize access due to read/write dependencies among transactions"</span> <span class="kw">in</span> <span class="bu">str</span>(excinfo.value)</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>found <span class="op">=</span> ses_autocommit.query(Product).<span class="bu">filter</span>(Product.name <span class="op">==</span> unique_name).<span class="bu">all</span>()</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">len</span>(found) <span class="op">==</span> <span class="dv">1</span>, <span class="st">"Uniqness checking logic was not bypassed! :)"</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>How technically this is implemented?</strong></p>
<p>So called <strong>predicate locks</strong> are used. Conceptually, on each your <code>SELECT</code> query, the predicate is saved (basically, <code>WHERE</code> condition, defining the set of rows returned). They doesn’t really lock anything, but just are used to find out dependencies between transactions. If it’s not possible to reorder and serialize them (which means, cycles present), a transaction (the last one) is rejected.</p>
<p>This is a difference from optimistic row-level locks, available at RR, where last transaction is always rejected. In the case predicate logs, Postgres will try to reorder transactions, and only if it’s not possible - reject one.</p>
<p>In the following example, you see a reordering of transactions. Alice already created a product and commited by the time Bob takes a decision based on already outdated information. Despite that, it’s possible to reorder transactions (first Bob, then Alice) making both Alice’c and Bob’s actions consistent.<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> This is quite fair: which transaction would be committed first, Alice or Bob, is anyway a random choice.</p>
<div class="no-row-height column-margin column-container"><div id="fn5"><p><sup>5</sup>&nbsp;The subtle difference from the previous example is only in the step 2. When Bob creates record in <code>products</code> table, it makes transactions non-serializable. When there’s a write to <code>users</code> table - all good.</p></div></div><div id="cell-34" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>clean_table()</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>unique_name <span class="op">=</span> <span class="st">'Unique'</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Both transactions should be serial. !!</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> (</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    SerializableSession() <span class="im">as</span> Alice,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    SerializableSession() <span class="im">as</span> Bob</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">#1 Alice checks the name is not taken, and takes it</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    found <span class="op">=</span> Alice.query(Product).<span class="bu">filter</span>(Product.name <span class="op">==</span> unique_name).<span class="bu">all</span>()</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="kw">not</span> found, <span class="st">"Alice decides the name is not taken"</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    Alice.add(Product(name<span class="op">=</span>unique_name))</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">#2 Bob does the same</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    found <span class="op">=</span> Bob.query(Product).<span class="bu">filter</span>(Product.name <span class="op">==</span> unique_name).<span class="bu">all</span>()</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="kw">not</span> found, <span class="st">"Bob decides the name is not taken"</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    Bob.add(</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>        User(name<span class="op">=</span><span class="ss">f"I'm Bob who observed </span><span class="sc">{</span><span class="bu">len</span>(found)<span class="sc">}</span><span class="ss"> products in db."</span>)</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">#3</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    Alice.commit()</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">#4</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>    Bob.commit()</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>found <span class="op">=</span> ses_autocommit.query(Product).<span class="bu">filter</span>(Product.name <span class="op">==</span> unique_name).<span class="bu">all</span>()</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">len</span>(found) <span class="op">==</span> <span class="dv">1</span>, <span class="st">"Uniqness checking logic was not bypassed! :)"</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> (</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>    ses_autocommit.query(User).first().name </span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">==</span> <span class="st">"I'm Bob who observed 0 products in db."</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>An important thing to clarify: <strong>both transactions should be of Serializable level</strong> to enforce this behaviour. In other words - those checks works only between serializable transactions. If some transaction on lower level changes the data that you read inside Serializable, nothing will prevent you to commit (and probably make an error).</p>
<div id="cell-36" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Case of one transaction of lower level</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>clean_table()</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Both transactions should be serial. !!</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> (</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    SerializableSession() <span class="im">as</span> Alice,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    ReadCommittedSession() <span class="im">as</span> Bob  </span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">#1</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    read_products <span class="op">=</span> <span class="bu">list</span>(Alice.query(Product).<span class="bu">all</span>() )</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(read_products)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    Bob.add(Product(name<span class="op">=</span><span class="st">'this product is something new, not seen by Alice yet'</span>))</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    Bob.commit()</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    Alice.add(Product(name<span class="op">=</span><span class="st">'something'</span>))</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    Alice.commit()</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> ses_autocommit.query(Product).count() <span class="op">==</span> <span class="dv">2</span>, <span class="st">"both transactions accepted"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[]</code></pre>
</div>
</div>
</section>
<section id="summary---mental-model" class="level1 page-columns page-full" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Summary - mental model</h1>
<p>Let’s summarize isolation levels of Postgres. This is a table taken from official postgres documention: <img src="Postgres_iso_levels.png" id="fig-postgres-levels" class="img-fluid" alt="Isolation levels (from postgres doc.)"></p>
<p>I propose an alternative model of thinking about these levels, which I find more simple and easier to remember.</p>
<div id="tbl-letters" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-float-tbl figure page-columns page-full">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-letters-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: My model of isolation levels
</figcaption>
<div aria-describedby="tbl-letters-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<table class="caption-top table">
<colgroup>
<col style="width: 30%">
<col style="width: 20%">
<col style="width: 23%">
<col style="width: 26%">
</colgroup>
<thead>
<tr class="header">
<th>level</th>
<th style="text-align: left;">Which data you can see/modify?<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a></th>
<th style="text-align: right;">Optimistic locking?</th>
<th style="text-align: center;">What happens on commit?</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>RC</td>
<td style="text-align: left;">Fresh current state, committed so far</td>
<td style="text-align: right;">No</td>
<td style="text-align: center;">_</td>
</tr>
<tr class="even">
<td>RR</td>
<td style="text-align: left;">Snapshot - comitted by the start of tr.</td>
<td style="text-align: right;">On records you modified</td>
<td style="text-align: center;">Abort, if conflict detected</td>
</tr>
<tr class="odd">
<td>S</td>
<td style="text-align: left;">Snapshot - comitted by the start of tr.</td>
<td style="text-align: right;">Plus, on predicates you used (either in SELECT or bulk UPDATE)</td>
<td style="text-align: center;">Try to reorder transactions, if not possible - abort the last one</td>
</tr>
</tbody>
</table>
<div class="no-row-height column-margin column-container"><div id="fn6"><p><sup>6</sup>&nbsp;Besides created by me during this transaction execution.</p></div></div></div>
</figure>
</div>


</section>


</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/mihasK\.github\.io\/mq\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"openEffect":"zoom","loop":false,"closeEffect":"zoom","selector":".lightbox","descPosition":"bottom"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>